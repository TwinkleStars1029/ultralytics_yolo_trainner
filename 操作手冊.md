# 桌面訓練工具 操作手冊

本手冊說明如何使用本專案完成資料前處理、產生 YOLO 訓練所需的 `data.yaml`，以及 GUI/CLI 的基本操作流程。特別支持將空標註（空 `.txt`）視為負樣本，並於資料分割時依比例做「分層切分」。

---

## 環境安裝
- Python 3.10+
- 進入專案根目錄後安裝相依：
  - `pip install -r trainer_desktop/requirements.txt`
  - Tkinter 為標準庫，Windows 與大部分 Python 發行版皆內建。

---

## 輸入資料格式
請先將影像與 YOLO 格式標註放在同一資料夾，例如：

```
<input_dir>/
  0001.jpg
  0001.txt     # YOLO 標註，格式：class x y w h（皆為 0~1）
  0002.jpg
  0002.txt
  classes.txt  # 每行一個類別名稱
```

- 允許空白標註檔（即 `.txt` 存在但內容為空），此類視為「負樣本」。
- 若影像沒有對應標註檔，該影像不會被納入處理。

---

## 輸出資料結構
執行後（非 Dry-Run）會於 `runs/<run_name>/` 產生：

```
runs/<run_name>/
  train/
    images/ ...
    labels/ ...
  valid/
    images/ ...
    labels/ ...
  test/
    images/ ...
    labels/ ...
  classes.txt
  train.txt
  val.txt
  test.txt
  data.yaml        # 由 YAML 產生器建立
  summary.json     # 數量統計、空標註計數、警告訊息
```

---

## GUI 操作
啟動指令：`python train.py gui`

### 頁面與欄位說明總覽
- Data Prep：資料前處理 + YAML 產生器（同一頁，完成後自動帶入 Run Folder）
- Train：在 Docker 容器中啟動訓練、查看日誌、進度與匯出/轉換模型

### Data Prep（資料前處理 + YAML）分頁
- 欄位與按鈕：
  - Input Folder：選擇輸入資料夾（內含影像、對應 `.txt` 標註與根層 `classes.txt`）。
    - Browse：開啟檔案夾選擇器以設定 Input Folder。
  - Runs Folder：輸出根目錄（預設為專案根下 `runs/`）。
    - Browse：開啟檔案夾選擇器以設定 Runs Folder。
  - Train Ratio (0-1)：訓練集比例（例如 0.7）。
  - Val Ratio (0-1)：驗證集比例（例如 0.2）。測試集比例 = 1 - Train - Val。
  - Seed：隨機種子（影響切分結果的隨機性）。
  - Run Name：輸出資料夾名稱（預設時間戳）。
  - Dry-Run only (no write)：勾選後僅進行檢查與統計，不會寫出任何檔案。
  - Dry-Run Preview：以 Dry-Run 執行一次檢查，僅在畫面顯示預覽結果。
  - Start Data Prep：開始實際前處理並寫出檔案至 `runs/<Run Name>/`。
  - 下方 Log：顯示進度、統計與警告訊息。
- 行為說明：
  - 前處理在背景執行緒執行，過程中按鈕會鎖定避免重複觸發。
  - 會驗證每個標註行格式與座標合理性，並統計「空標註」（負樣本）數量。
  - 採「分層切分」：先分開空標註與一般樣本，各自依比例切分，再合併為 train/valid/test，使負樣本比例在各分割中維持接近整體水準。

#### YAML 產生器（同頁區塊）

- 提示：完成 Data Prep 後，Run Folder 會自動帶入剛產生的 run 目錄。
- 欄位與按鈕：
  - Run Folder：選擇上一步 Data Prep 產生的 run 目錄（內含 `classes.txt` 與 `train/val/test.txt`）。
    - Browse：開啟檔案夾選擇器以設定 Run Folder。
  - Dataset Path in YAML：`data.yaml` 內的 `path` 欄位（留空則使用 Run Folder 路徑）。
  - Preview YAML：先在右側 Log 區塊顯示將要寫入的 YAML 內容。
  - Write data.yaml：實際輸出 `data.yaml` 到所選 run 目錄。
- 行為說明：
  - 產生器會讀取 `classes.txt` 並依模板輸出 `data.yaml`；若 `path` 留空，會落入 Run Folder 的實際路徑。
  - 操作在背景執行緒進行，完成後會於 Log 顯示完成訊息或錯誤原因。

### Train（訓練）分頁（Docker 內執行）
- 前置條件：
  - 需有已啟動的 Docker 容器（預設名稱 `ultralytics_1016`）。
  - 容器內工作目錄需存在 `train_obj.py`（啟動訓練的腳本）。
  - 建議已完成 Data Prep 與 `data.yaml` 準備，並確保 Host 的 `runs/` 有對應掛載至容器（便於輸出與日誌保存）。
- 參數表單：
  - Container：Docker 容器名稱（預設 `ultralytics_1016`）。
  - Project：專案名稱；同時作為 Host `runs/<Project>/` 的輸出與日誌保存目錄。
  - DataName：傳入 `train_obj.py` 的 `--dataName` 參數（應對應資料集名稱／YAML 設定）。
  - Epochs：訓練輪數，獨立欄位（預設 200）。若 Extra args 內同時包含 `--epochs`，會被此欄位覆蓋（系統會移除 Extra args 中的 `--epochs` 並以欄位值為準）。
  - Extra args：額外傳給 `train_obj.py` 的參數字串（例如 `--batch 16 --imgsz 640`）。
  - 進階：
    - Resume (--resume)：勾選後會附帶 `--resume` 續訓。
    - GPU：指定 `CUDA_VISIBLE_DEVICES`（例如 `0` 或 `0,1`）。
- 控制按鈕：
  - Start Training：
    - 執行前會做快速檢查：容器是否執行中、容器內是否存在 `train_obj.py`。
    - 啟動前會檢查本機 `runs/<Project>/` 是否已存在：若存在且未勾選 Resume，將停止啟動並在 My Log 顯示「project name重複，請更換名稱」。
    - 觸發後於容器內執行：`python -u train_obj.py --project='<Project>' --dataName='<DataName>' [--resume] --epochs=<N> <Extra args>`。
    - 執行期間會串流日誌至 UI 與 `runs/<Project>/train.log`，並解析 `epoch a/b` 更新進度條。
  - Stop：嘗試於容器內以 `pkill -f 'python -u train_obj.py'` 中止訓練流程。
  - Open Output Folder：開啟 Host 端 `runs/<Project>/` 資料夾。
- 進度與日誌：
  - Progress Bar：根據日誌內 `epoch a/b` 自動換算百分比並顯示於右側。
  - Log Viewer：
    - My Log：顯示工具本身的提示、結果與錯誤摘要。
    - CMD Output：顯示容器內訓練指令的即時輸出（原始 stdout）。
- 匯出／轉換（Export / Convert）區塊：
  - Weights (pt or path)：
    - 可輸入權重名稱（如 `best.pt`），或容器內的絕對/相對路徑。
    - 若僅輸入名稱，預設解析為：`/ultralytics/runs/detect/<Project>/weights/<name>.pt`。
  - imgsz：匯出 ONNX 時的輸入尺寸（整數，如 640）。
  - Export → IR：啟動「串接流程」：
    1) 先在容器內以 Ultralytics API 匯出 ONNX（`export_onnx.log`）。
    2) 匯出成功後，接著嘗試以 `ovc`（新）或 `mo`（舊版 Model Optimizer）轉換為 OpenVINO IR（`export_ir.log`）。
    - 轉換精度預設 FP16；輸出位置為 ONNX 所在的同一資料夾。
  - ONNX (path or name)：供 IR 轉換步驟選擇 ONNX；留空則自動從權重名稱推導（或使用您輸入的 ONNX 名稱）。
- 注意事項：
  - 匯出/轉換的「快速檢查」僅確認容器是否執行中；如容器內缺少 `ovc`/`mo` 轉換工具，會在執行時出錯（錯誤訊息將出現在 CMD Output）。
  - 權重與輸出路徑皆以「容器內路徑」為準進行；請確保容器有正確的掛載與檔案可見性。

---

## CLI 操作

### 前處理
```
python train.py prep \
  --input 20241206_K2_DR02_v18.1_ \
  --runs runs \
  --train 0.7 --val 0.2 \
  --seed 42 \
  --name K2_DR02_v18_1 \
  [--dry-run]
```
- 分層切分：空標註（負樣本）與一般樣本分別依比例切分，再合併為 train/valid/test，以維持各分割中負樣本比例。

### 產生 YAML
```
python train.py yaml \
  --run runs/K2_DR02_v18_1 \
  --path runs/K2_DR02_v18_1
```

---

## summary.json 範例說明
`runs/<run_name>/summary.json` 會包含：
- `total_images`：總影像數
- `train/valid/test`：各分割影像數
- `empty_labels`：空標註檔數（全體）
- `class_distribution`：依類別的標註數量
- `warnings`：格式錯誤或異常訊息

---

## 常見問題
- 找不到 `classes.txt`
  - 請確認輸入目錄根層有 `classes.txt`，且每行一個類別名。
- 標註格式錯誤
  - YOLO 格式需為 `class x y w h`，且數值需落在 `[0,1]`。
- 影像有但沒有 `.txt`
  - 該影像將不被納入資料集；若要作為負樣本，請建立同名空 `.txt`。

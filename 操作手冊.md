# 桌面訓練工具 操作手冊

本手冊說明如何使用本專案完成資料前處理、產生 YOLO 訓練所需的 `data.yaml`，以及 GUI/CLI 的基本操作流程。特別支持將空標註（空 `.txt`）視為負樣本，並於資料分割時依比例做「分層切分」。

---

## 環境安裝
- Python 3.10+
- 進入專案根目錄後安裝相依：
  - `pip install -r trainer_desktop/requirements.txt`
  - Tkinter 為標準庫，Windows 與大部分 Python 發行版皆內建。

---

## 輸入資料格式
請先將影像與 YOLO 格式標註放在同一資料夾，例如：

```
<input_dir>/
  0001.jpg
  0001.txt     # YOLO 標註，格式：class x y w h（皆為 0~1）
  0002.jpg
  0002.txt
  classes.txt  # 每行一個類別名稱
```

- 允許空白標註檔（即 `.txt` 存在但內容為空），此類視為「負樣本」。
- 若影像沒有對應標註檔，該影像不會被納入處理。

---

## 輸出資料結構
執行後（非 Dry-Run）會於 `runs/<run_name>/` 產生：

```
runs/<run_name>/
  train/
    images/ ...
    labels/ ...
  valid/
    images/ ...
    labels/ ...
  test/
    images/ ...
    labels/ ...
  classes.txt
  train.txt
  val.txt
  test.txt
  data.yaml        # 由 YAML 產生器建立
  summary.json     # 數量統計、空標註計數、警告訊息
```

---

## GUI 操作
啟動指令：`python train.py gui`

### Data Prep（資料前處理）分頁
- 輸入參數：
  - Input Folder：輸入資料夾（需含影像、`.txt` 與 `classes.txt`）
  - Runs Folder：輸出根目錄（預設 `./runs`）
  - Train/Val Ratio：訓練/驗證比例（測試比例 = 1 - Train - Val）
  - Seed：隨機種子
  - Run Name：輸出目錄名稱（預設時間戳）
  - Dry-Run：只檢查不落檔
- 背景執行：前處理作業在背景執行緒進行，UI 不會卡住。
- 負樣本（空標註）處理：以「分層切分」策略，確保 train/valid/test 中負樣本比例與整體一致。

### YAML Generator（YAML 產生器）分頁
- Run Folder：選擇上一步產生的 run 目錄
- Dataset Path in YAML：`data.yaml` 內的 `path` 欄位（留空則使用 run 目錄路徑）
- 可先 Preview，再 Write 輸出 `data.yaml`

---

## CLI 操作

### 前處理
```
python train.py prep \
  --input 20241206_K2_DR02_v18.1_ \
  --runs runs \
  --train 0.7 --val 0.2 \
  --seed 42 \
  --name K2_DR02_v18_1 \
  [--dry-run]
```
- 分層切分：空標註（負樣本）與一般樣本分別依比例切分，再合併為 train/valid/test，以維持各分割中負樣本比例。

### 產生 YAML
```
python train.py yaml \
  --run runs/K2_DR02_v18_1 \
  --path runs/K2_DR02_v18_1
```

---

## summary.json 範例說明
`runs/<run_name>/summary.json` 會包含：
- `total_images`：總影像數
- `train/valid/test`：各分割影像數
- `empty_labels`：空標註檔數（全體）
- `class_distribution`：依類別的標註數量
- `warnings`：格式錯誤或異常訊息

---

## 常見問題
- 找不到 `classes.txt`
  - 請確認輸入目錄根層有 `classes.txt`，且每行一個類別名。
- 標註格式錯誤
  - YOLO 格式需為 `class x y w h`，且數值需落在 `[0,1]`。
- 影像有但沒有 `.txt`
  - 該影像將不被納入資料集；若要作為負樣本，請建立同名空 `.txt`。

